-- Warpah Fling GUI - Multi Target Version (FIXED AUTO REFRESH)
-- Touch fling gui with player selection

-- Instances:
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local TopFrame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local MinimizeButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")
local ContentFrame = Instance.new("Frame")
local PlayerListFrame = Instance.new("ScrollingFrame")
local ControlFrame = Instance.new("Frame")
local SelectAllButton = Instance.new("TextButton")
local UnselectAllButton = Instance.new("TextButton")
local StartButton = Instance.new("TextButton")
local StopButton = Instance.new("TextButton")
local StatusLabel = Instance.new("TextLabel")
local NeonBorder = Instance.new("Frame")

-- Services
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Properties:
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false
print("Warpah Fling GUI Loaded")

-- Main Frame (DIPERKECIL)
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.4, 0, 0.3, 0)
MainFrame.Size = UDim2.new(0, 250, 0, 350)
MainFrame.Active = true
MainFrame.Draggable = true

-- Neon Border Effect
NeonBorder.Parent = MainFrame
NeonBorder.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
NeonBorder.BackgroundTransparency = 0.3
NeonBorder.BorderSizePixel = 0
NeonBorder.Position = UDim2.new(0, -2, 0, -2)
NeonBorder.Size = UDim2.new(1, 4, 1, 4)
NeonBorder.ZIndex = -1

-- Top Frame (Header)
TopFrame.Parent = MainFrame
TopFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TopFrame.BorderSizePixel = 0
TopFrame.Size = UDim2.new(1, 0, 0, 30)

-- Title Label
TitleLabel.Parent = TopFrame
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.Size = UDim2.new(0.7, -10, 1, 0)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "Warpah Fling"
TitleLabel.TextColor3 = Color3.fromRGB(0, 255, 127)
TitleLabel.TextSize = 16
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Minimize Button
MinimizeButton.Parent = TopFrame
MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
MinimizeButton.BorderSizePixel = 0
MinimizeButton.Position = UDim2.new(1, -50, 0, 5)
MinimizeButton.Size = UDim2.new(0, 20, 0, 20)
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.Text = "—"
MinimizeButton.TextColor3 = Color3.fromRGB(0, 0, 0)
MinimizeButton.TextSize = 14

-- Close Button
CloseButton.Parent = TopFrame
CloseButton.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
CloseButton.BorderSizePixel = 0
CloseButton.Position = UDim2.new(1, -25, 0, 5)
CloseButton.Size = UDim2.new(0, 20, 0, 20)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 14

-- Content Frame
ContentFrame.Parent = MainFrame
ContentFrame.BackgroundTransparency = 1
ContentFrame.Position = UDim2.new(0, 0, 0, 30)
ContentFrame.Size = UDim2.new(1, 0, 1, -30)

-- Status Label
StatusLabel.Parent = ContentFrame
StatusLabel.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
StatusLabel.BorderSizePixel = 0
StatusLabel.Position = UDim2.new(0, 10, 0, 5)
StatusLabel.Size = UDim2.new(1, -20, 0, 20)
StatusLabel.Font = Enum.Font.GothamSemibold
StatusLabel.Text = "Status: OFF"
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.TextSize = 12

-- Player List Frame
PlayerListFrame.Parent = ContentFrame
PlayerListFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
PlayerListFrame.BorderSizePixel = 0
PlayerListFrame.Position = UDim2.new(0, 10, 0, 30)
PlayerListFrame.Size = UDim2.new(1, -20, 1, -110)
PlayerListFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerListFrame.ScrollBarThickness = 4
PlayerListFrame.ScrollBarImageColor3 = Color3.fromRGB(0, 255, 127)

-- Control Frame
ControlFrame.Parent = ContentFrame
ControlFrame.BackgroundTransparency = 1
ControlFrame.Position = UDim2.new(0, 10, 1, -75)
ControlFrame.Size = UDim2.new(1, -20, 0, 75)

-- Select All Button
SelectAllButton.Parent = ControlFrame
SelectAllButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SelectAllButton.BorderSizePixel = 0
SelectAllButton.Position = UDim2.new(0, 0, 0, 0)
SelectAllButton.Size = UDim2.new(0.48, 0, 0, 30)
SelectAllButton.Font = Enum.Font.GothamSemibold
SelectAllButton.Text = "Select All"
SelectAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SelectAllButton.TextSize = 13

-- Unselect All Button
UnselectAllButton.Parent = ControlFrame
UnselectAllButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
UnselectAllButton.BorderSizePixel = 0
UnselectAllButton.Position = UDim2.new(0.52, 0, 0, 0)
UnselectAllButton.Size = UDim2.new(0.48, 0, 0, 30)
UnselectAllButton.Font = Enum.Font.GothamSemibold
UnselectAllButton.Text = "Unselect All"
UnselectAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnselectAllButton.TextSize = 13

-- Start Button
StartButton.Parent = ControlFrame
StartButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
StartButton.BorderSizePixel = 0
StartButton.Position = UDim2.new(0, 0, 0, 38)
StartButton.Size = UDim2.new(0.48, 0, 0, 32)
StartButton.Font = Enum.Font.GothamSemibold
StartButton.Text = "START"
StartButton.TextColor3 = Color3.fromRGB(0, 255, 127)
StartButton.TextSize = 15

-- Stop Button
StopButton.Parent = ControlFrame
StopButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
StopButton.BorderSizePixel = 0
StopButton.Position = UDim2.new(0.52, 0, 0, 38)
StopButton.Size = UDim2.new(0.48, 0, 0, 32)
StopButton.Font = Enum.Font.GothamSemibold
StopButton.Text = "STOP"
StopButton.TextColor3 = Color3.fromRGB(220, 53, 69)
StopButton.TextSize = 15

-- Variables
local isMinimized = false
local originalSize = MainFrame.Size
local minimizedSize = UDim2.new(0, 250, 0, 30)
local selectedPlayers = {}
local isFling = false
local flingConnection

-- Animations
local function createTween(object, properties, duration)
    local tweenInfo = TweenInfo.new(
        duration or 0.3,
        Enum.EasingStyle.Quart,
        Enum.EasingDirection.Out
    )
    return TweenService:Create(object, tweenInfo, properties)
end

-- Neon glow animation
local function animateNeonGlow()
    spawn(function()
        while NeonBorder.Parent do
            local glowTween = createTween(NeonBorder, {
                BackgroundTransparency = 0.1
            }, 1)
            local dimTween = createTween(NeonBorder, {
                BackgroundTransparency = 0.5
            }, 1)
            
            glowTween:Play()
            glowTween.Completed:Wait()
            dimTween:Play()
            dimTween.Completed:Wait()
        end
    end)
end

-- Start neon animation
animateNeonGlow()

-- Player List Functions (FIXED VERSION)
local function createPlayerEntry(player)
    local entry = Instance.new("Frame")
    entry.Name = player.Name
    entry.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    entry.BorderSizePixel = 0
    entry.Size = UDim2.new(1, -8, 0, 30)
    
    local checkbox = Instance.new("TextButton")
    checkbox.Name = "Checkbox"
    checkbox.Parent = entry
    checkbox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    checkbox.BorderSizePixel = 1
    checkbox.BorderColor3 = Color3.fromRGB(0, 255, 127)
    checkbox.Position = UDim2.new(0, 5, 0.5, -10)
    checkbox.Size = UDim2.new(0, 20, 0, 20)
    checkbox.Font = Enum.Font.GothamBold
    checkbox.Text = ""
    checkbox.TextColor3 = Color3.fromRGB(0, 255, 127)
    checkbox.TextSize = 14
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Parent = entry
    nameLabel.BackgroundTransparency = 1
    nameLabel.Position = UDim2.new(0, 30, 0, 0)
    nameLabel.Size = UDim2.new(1, -30, 1, 0)
    nameLabel.Font = Enum.Font.Gotham
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextSize = 13
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Set checkbox state berdasarkan selectedPlayers (PENTING!)
    if selectedPlayers[player.Name] then
        checkbox.Text = "✓"
        checkbox.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
    end
    
    -- Checkbox functionality
    checkbox.MouseButton1Click:Connect(function()
        if selectedPlayers[player.Name] then
            selectedPlayers[player.Name] = nil
            checkbox.Text = ""
            checkbox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        else
            selectedPlayers[player.Name] = player
            checkbox.Text = "✓"
            checkbox.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
        end
    end)
    
    return entry
end

-- FIXED: Update player list dengan error handling
local function updatePlayerList()
    -- Bersihkan entry lama
    for _, child in ipairs(PlayerListFrame:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    -- Bersihkan selectedPlayers dari player yang sudah keluar
    local currentPlayers = {}
    for _, player in ipairs(Players:GetPlayers()) do
        currentPlayers[player.Name] = true
    end
    
    for playerName, _ in pairs(selectedPlayers) do
        if not currentPlayers[playerName] then
            selectedPlayers[playerName] = nil
        end
    end
    
    -- Buat entry baru untuk semua player
    local yOffset = 5
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            local success, entry = pcall(function()
                return createPlayerEntry(player)
            end)
            
            if success and entry then
                entry.Parent = PlayerListFrame
                entry.Position = UDim2.new(0, 4, 0, yOffset)
                yOffset = yOffset + 35
            end
        end
    end
    
    PlayerListFrame.CanvasSize = UDim2.new(0, 0, 0, yOffset)
end

-- Initial player list
updatePlayerList()

-- FIXED: Auto refresh saat player join
Players.PlayerAdded:Connect(function(player)
    task.wait(0.5) -- Tunggu sebentar agar character loaded
    updatePlayerList()
    print("Player joined: " .. player.Name)
end)

-- FIXED: Auto refresh saat player leave dengan cleanup
Players.PlayerRemoving:Connect(function(player)
    if selectedPlayers[player.Name] then
        selectedPlayers[player.Name] = nil
        print("Removed from selection: " .. player.Name)
    end
    task.wait(0.1)
    updatePlayerList()
    print("Player left: " .. player.Name)
end)

-- Select All Button
SelectAllButton.MouseButton1Click:Connect(function()
    for _, entry in ipairs(PlayerListFrame:GetChildren()) do
        if entry:IsA("Frame") then
            local checkbox = entry:FindFirstChild("Checkbox")
            local player = Players:FindFirstChild(entry.Name)
            if checkbox and player then
                selectedPlayers[player.Name] = player
                checkbox.Text = "✓"
                checkbox.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
            end
        end
    end
end)

-- Unselect All Button
UnselectAllButton.MouseButton1Click:Connect(function()
    for _, entry in ipairs(PlayerListFrame:GetChildren()) do
        if entry:IsA("Frame") then
            local checkbox = entry:FindFirstChild("Checkbox")
            if checkbox then
                checkbox.Text = ""
                checkbox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
        end
    end
    selectedPlayers = {}
end)

-- Advanced Fling functionality
local function startFling()
    if isFling then return end
    isFling = true
    
    local lp = Players.LocalPlayer
    local movel = 0.1
    
    spawn(function()
        while isFling do
            for playerName, targetPlayer in pairs(selectedPlayers) do
                if not isFling then break end
                
                -- FIXED: Validasi player masih ada
                if not targetPlayer or not targetPlayer.Parent then
                    selectedPlayers[playerName] = nil
                    continue
                end
                
                if targetPlayer and targetPlayer.Character then
                    local targetChar = targetPlayer.Character
                    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
                    local targetHum = targetChar:FindFirstChild("Humanoid")
                    
                    if targetHRP and targetHum and targetHum.Health > 0 then
                        StatusLabel.Text = "Flinging: " .. playerName
                        StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 127)
                        
                        local startPosY = targetHRP.Position.Y
                        local isFlung = false
                        
                        while not isFlung and isFling do
                            local c = lp.Character
                            local hrp = c and c:FindFirstChild("HumanoidRootPart")
                            
                            if hrp and targetHRP then
                                local scanPositions = {
                                    targetHRP.CFrame * CFrame.new(1, 0, 0),
                                    targetHRP.CFrame * CFrame.new(-1, 0, 0),
                                    targetHRP.CFrame * CFrame.new(0, 0, 1),
                                    targetHRP.CFrame * CFrame.new(0, 0, -1),
                                    targetHRP.CFrame * CFrame.new(1, 1, 1),
                                    targetHRP.CFrame * CFrame.new(-1, -1, -1),
                                }
                                
                                for _, pos in ipairs(scanPositions) do
                                    if not isFling then break end
                                    
                                    hrp.CFrame = pos
                                    
                                    local vel = hrp.Velocity
                                    hrp.Velocity = vel * 10000 + Vector3.new(0, 10000, 0)
                                    RunService.RenderStepped:Wait()
                                    hrp.Velocity = vel
                                    RunService.Stepped:Wait()
                                    hrp.Velocity = vel + Vector3.new(0, movel, 0)
                                    movel = -movel
                                    
                                    if targetHRP.Position.Y > startPosY + 50 or targetHRP.Velocity.Y > 100 then
                                        isFlung = true
                                        StatusLabel.Text = playerName .. " Flinged!"
                                        StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 127)
                                        break
                                    end
                                    
                                    task.wait(0.01)
                                end
                            else
                                break
                            end
                        end
                        
                        task.wait(0.3)
                    end
                end
            end
            
            if isFling then
                StatusLabel.Text = "Repeating..."
                StatusLabel.TextColor3 = Color3.fromRGB(255, 193, 7)
                task.wait(0.5)
            end
        end
    end)
end

local function stopFling()
    isFling = false
    StatusLabel.Text = "Status: OFF"
    StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
end

-- Start Button
StartButton.MouseButton1Click:Connect(function()
    local count = 0
    for _ in pairs(selectedPlayers) do count = count + 1 end
    
    if count == 0 then
        StatusLabel.Text = "Select Players First!"
        StatusLabel.TextColor3 = Color3.fromRGB(220, 53, 69)
        wait(2)
        StatusLabel.Text = "Status: OFF"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        return
    end
    
    StartButton.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
    StartButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    StatusLabel.Text = "Status: ON"
    StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 127)
    startFling()
end)

-- Stop Button
StopButton.MouseButton1Click:Connect(function()
    StartButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    StartButton.TextColor3 = Color3.fromRGB(0, 255, 127)
    stopFling()
end)

-- Minimize/Maximize functionality
MinimizeButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    
    local targetSize = isMinimized and minimizedSize or originalSize
    local sizeTween = createTween(MainFrame, {Size = targetSize})
    
    ContentFrame.Visible = not isMinimized
    MinimizeButton.Text = isMinimized and "□" or "—"
    
    sizeTween:Play()
end)

-- Close functionality
CloseButton.MouseButton1Click:Connect(function()
    stopFling()
    
    local closeTween = createTween(MainFrame, {
        Size = UDim2.new(0, 0, 0, 0),
        BackgroundTransparency = 1
    })
    
    closeTween:Play()
    closeTween.Completed:Connect(function()
        ScreenGui:Destroy()
    end)
end)

-- Button hover effects
local function addHoverEffect(button, hoverColor, originalColor)
    button.MouseEnter:Connect(function()
        createTween(button, {BackgroundColor3 = hoverColor}):Play()
    end)
    
    button.MouseLeave:Connect(function()
        createTween(button, {BackgroundColor3 = originalColor}):Play()
    end)
end

-- Apply hover effects
addHoverEffect(MinimizeButton, Color3.fromRGB(255, 235, 59), Color3.fromRGB(255, 193, 7))
addHoverEffect(CloseButton, Color3.fromRGB(244, 67, 54), Color3.fromRGB(220, 53, 69))
addHoverEffect(SelectAllButton, Color3.fromRGB(50, 50, 50), Color3.fromRGB(40, 40, 40))
addHoverEffect(UnselectAllButton, Color3.fromRGB(50, 50, 50), Color3.fromRGB(40, 40, 40))
