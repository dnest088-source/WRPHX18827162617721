-- Warpah No Clip System - Fixed Dragging Issue
-- Bypass kurungan, barrier, dan reload systems
-- Fixed: GUI dragging shadow issue, improved UI stability

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- Konfigurasi Noclip
local NOCLIP_ENABLED = false
local NOCLIP_SPEED = 16
local AUTO_NOCLIP = false
local SMART_DETECTION = true
local BYPASS_RELOAD = true
local INVISIBILITY_ENABLED = false

-- Variables untuk state management
local originalStates = {}
local noclipConnection = nil
local isStuck = false
local stuckTimer = 0
local lastPosition = nil

-- GUI State Management
local guiMinimized = false
local guiVisible = true
local isDragging = false

-- Blacklist parts yang tidak boleh di-noclip
local partBlacklist = {
    "Baseplate",
    "SpawnLocation", 
    "Spawn"
}

-- Fungsi untuk cek apakah part aman untuk di-noclip
local function isSafeToNoclip(part)
    if not part or not part.Name then return false end
    
    for _, blacklisted in pairs(partBlacklist) do
        if string.find(string.lower(part.Name), string.lower(blacklisted)) then
            return false
        end
    end
    
    -- Jangan noclip ground/floor
    if part.Position.Y < -10 then
        return false
    end
    
    return true
end

-- Fungsi untuk backup state asli character
local function backupCharacterStates()
    if not LocalPlayer.Character then return end
    
    for _, part in pairs(LocalPlayer.Character:GetChildren()) do
        if part:IsA("BasePart") then
            originalStates[part] = {
                CanCollide = part.CanCollide,
                Transparency = part.Transparency
            }
        elseif part:IsA("Accessory") then
            local handle = part:FindFirstChild("Handle")
            if handle then
                originalStates[handle] = {
                    CanCollide = handle.CanCollide,
                    Transparency = handle.Transparency
                }
            end
        end
    end
end

-- Fungsi untuk restore state asli
local function restoreCharacterStates()
    if not LocalPlayer.Character then return end
    
    for part, states in pairs(originalStates) do
        if part and part.Parent then
            part.CanCollide = states.CanCollide
            if not INVISIBILITY_ENABLED then
                part.Transparency = states.Transparency
            end
        end
    end
    
    originalStates = {}
end

-- Fungsi untuk invisibility character
local function toggleInvisibility()
    if not LocalPlayer.Character then return end
    
    INVISIBILITY_ENABLED = not INVISIBILITY_ENABLED
    
    for _, part in pairs(LocalPlayer.Character:GetChildren()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
            if INVISIBILITY_ENABLED then
                part.Transparency = 1
            else
                part.Transparency = originalStates[part] and originalStates[part].Transparency or 0
            end
        elseif part:IsA("Accessory") then
            local handle = part:FindFirstChild("Handle")
            if handle then
                if INVISIBILITY_ENABLED then
                    handle.Transparency = 1
                else
                    handle.Transparency = originalStates[handle] and originalStates[handle].Transparency or 0
                end
            end
        end
    end
    
    -- Handle face decals
    local head = LocalPlayer.Character:FindFirstChild("Head")
    if head then
        local face = head:FindFirstChild("face")
        if face then
            if INVISIBILITY_ENABLED then
                face.Transparency = 1
            else
                face.Transparency = 0
            end
        end
    end
    
    print(INVISIBILITY_ENABLED and "ðŸ‘» Character is now INVISIBLE" or "ðŸ‘¤ Character is now VISIBLE")
end

-- Main Noclip Function dengan smart detection
local function performNoclip()
    if not LocalPlayer.Character then return end
    
    for _, part in pairs(LocalPlayer.Character:GetChildren()) do
        if part:IsA("BasePart") then
            -- Aktifkan noclip
            part.CanCollide = false
            
            -- Visual feedback (opsional transparency) - tidak berlaku jika invisibility aktif
            if NOCLIP_ENABLED and part.Name ~= "HumanoidRootPart" and not INVISIBILITY_ENABLED then
                part.Transparency = math.min(part.Transparency + 0.1, 0.7)
            end
        end
    end
end

-- Fungsi untuk deteksi kurungan/barrier
local function detectBarrier()
    if not LocalPlayer.Character then return false end
    
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Raycast ke semua arah untuk deteksi barrier
    local rayDirections = {
        Vector3.new(1, 0, 0),   -- kanan
        Vector3.new(-1, 0, 0),  -- kiri  
        Vector3.new(0, 0, 1),   -- depan
        Vector3.new(0, 0, -1),  -- belakang
        Vector3.new(0, 1, 0),   -- atas
        Vector3.new(0, -1, 0)   -- bawah
    }
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    
    local blockedCount = 0
    local totalRays = #rayDirections
    
    for _, direction in pairs(rayDirections) do
        local ray = workspace:Raycast(hrp.Position, direction * 3, raycastParams)
        if ray then
            blockedCount = blockedCount + 1
        end
    end
    
    -- Jika lebih dari 60% arah terblokir, kemungkinan terkurung
    return (blockedCount / totalRays) > 0.6
end

-- Fungsi untuk deteksi stuck/tidak bergerak
local function detectStuck()
    if not LocalPlayer.Character then return false end
    
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    
    if not hrp or not humanoid then return false end
    
    local currentPosition = hrp.Position
    
    -- Cek apakah posisi tidak berubah meski sedang bergerak
    if lastPosition then
        local distance = (currentPosition - lastPosition).Magnitude
        local isMoving = humanoid.MoveDirection.Magnitude > 0
        
        if isMoving and distance < 0.1 then
            stuckTimer = stuckTimer + 1
            if stuckTimer > 30 then -- Stuck selama 1 detik (30 frames)
                stuckTimer = 0
                lastPosition = currentPosition
                return true
            end
        else
            stuckTimer = 0
        end
    end
    
    lastPosition = currentPosition
    return false
end

-- Advanced Noclip dengan bypass reload
local function advancedNoclip()
    if not NOCLIP_ENABLED then return end
    
    performNoclip()
    
    -- Bypass reload systems
    if BYPASS_RELOAD then
        local character = LocalPlayer.Character
        if character then
            -- Bypass common reload/teleport methods
            for _, script in pairs(character:GetChildren()) do
                if script:IsA("LocalScript") or script:IsA("Script") then
                    if string.find(string.lower(script.Name), "reload") or
                       string.find(string.lower(script.Name), "teleport") or
                       string.find(string.lower(script.Name), "barrier") then
                        script.Disabled = true
                    end
                end
            end
            
            -- Disable physics pada semua part
            for _, part in pairs(character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                    
                    -- Anti-reload: hapus velocity constraints
                    for _, constraint in pairs(part:GetChildren()) do
                        if constraint:IsA("BodyVelocity") or 
                           constraint:IsA("BodyPosition") or
                           constraint:IsA("BodyAngularVelocity") then
                            constraint:Destroy()
                        end
                    end
                end
            end
        end
    end
end

-- Auto-noclip ketika terdeteksi barrier
local function autoNoclipCheck()
    if not AUTO_NOCLIP or not SMART_DETECTION then return end
    
    local isBarrierDetected = detectBarrier()
    local isStuckDetected = detectStuck()
    
    if (isBarrierDetected or isStuckDetected) and not NOCLIP_ENABLED then
        print("ðŸ”“ Auto-noclip activated - Barrier/Stuck detected")
        enableNoclip()
    elseif not isBarrierDetected and not isStuckDetected and NOCLIP_ENABLED and AUTO_NOCLIP then
        print("âœ… Auto-noclip deactivated - Clear path")
        disableNoclip()
    end
end

-- Fungsi untuk enable noclip
function enableNoclip()
    if NOCLIP_ENABLED then return end
    
    NOCLIP_ENABLED = true
    backupCharacterStates()
    
    noclipConnection = RunService.Stepped:Connect(advancedNoclip)
    
    print("ðŸ”“ Noclip ENABLED")
end

-- Fungsi untuk disable noclip  
function disableNoclip()
    if not NOCLIP_ENABLED then return end
    
    NOCLIP_ENABLED = false
    
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    restoreCharacterStates()
    
    print("ðŸ”’ Noclip DISABLED")
end

-- Custom dragging function to fix shadow issue
local function makeDraggable(frame, dragHandle)
    local dragToggle = nil
    local dragSpeed = 0
    local dragStart = nil
    local startPos = nil

    local function updateInput(input)
        local delta = input.Position - dragStart
        local position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        game:GetService('TweenService'):Create(frame, TweenInfo.new(dragSpeed), {Position = position}):Play()
    end

    dragHandle.InputBegan:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragToggle = true
            dragStart = input.Position
            startPos = frame.Position
            isDragging = true
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragToggle = false
                    isDragging = false
                end
            end)
        end
    end)

    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            if dragToggle then
                updateInput(input)
            end
        end
    end)
end

-- Fixed GUI dengan dragging yang diperbaiki
local function createNoclipGUI()
    -- Only create if not already exists
    if LocalPlayer.PlayerGui:FindFirstChild("WarpahNoclipGUI") then
        LocalPlayer.PlayerGui.WarpahNoclipGUI:Destroy()
    end
    
    local ScreenGui = Instance.new("ScreenGui")
    local MainFrame = Instance.new("Frame")
    local TitleBar = Instance.new("Frame")
    local TitleLabel = Instance.new("TextLabel")
    local MinimizeButton = Instance.new("TextButton")
    local CloseButton = Instance.new("TextButton")
    local ContentFrame = Instance.new("Frame")
    local NoclipToggle = Instance.new("TextButton")
    local AutoToggle = Instance.new("TextButton")
    local SpeedSlider = Instance.new("TextBox")
    local SpeedLabel = Instance.new("TextLabel")
    local StatusLabel = Instance.new("TextLabel")
    local BypassToggle = Instance.new("TextButton")
    local DetectionToggle = Instance.new("TextButton")
    local InvisibilityToggle = Instance.new("TextButton")
    local EmergencyButton = Instance.new("TextButton")
    
    ScreenGui.Name = "WarpahNoclipGUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    MainFrame.Size = UDim2.new(0, 300, 0, 290)
    MainFrame.Position = UDim2.new(0.5, -150, 0.5, -145)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    MainFrame.BackgroundTransparency = 0.05
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui
    
    local mainFrameCorner = Instance.new("UICorner")
    mainFrameCorner.CornerRadius = UDim.new(0, 12)
    mainFrameCorner.Parent = MainFrame
    
    -- Shadow effect (optional)
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 6, 1, 6)
    shadow.Position = UDim2.new(0, -3, 0, -3)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.8
    shadow.ZIndex = MainFrame.ZIndex - 1
    shadow.Parent = MainFrame
    
    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 12)
    shadowCorner.Parent = shadow
    
    -- Title Bar - Fixed untuk dragging
    TitleBar.Size = UDim2.new(1, 0, 0, 35)
    TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    TitleBar.BorderSizePixel = 0
    TitleBar.Active = false -- PENTING: Set ke false
    TitleBar.Parent = MainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = TitleBar
    
    -- Tambah frame khusus untuk menutupi sudut bawah title bar
    local titleBottomCover = Instance.new("Frame")
    titleBottomCover.Size = UDim2.new(1, 0, 0, 12)
    titleBottomCover.Position = UDim2.new(0, 0, 1, -12)
    titleBottomCover.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    titleBottomCover.BorderSizePixel = 0
    titleBottomCover.Parent = TitleBar
    
    TitleLabel.Size = UDim2.new(1, -70, 1, 0)
    TitleLabel.Position = UDim2.new(0, 10, 0, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = "ðŸ”® WARPAH NO CLIP"
    TitleLabel.TextColor3 = Color3.fromRGB(138, 43, 226)
    TitleLabel.TextSize = 14
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Active = false
    TitleLabel.Parent = TitleBar
    
    MinimizeButton.Size = UDim2.new(0, 30, 0, 25)
    MinimizeButton.Position = UDim2.new(1, -65, 0, 5)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
    MinimizeButton.Text = "âˆ’"
    MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeButton.TextSize = 16
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.Active = true
    MinimizeButton.Parent = TitleBar
    
    local minCorner = Instance.new("UICorner")
    minCorner.CornerRadius = UDim.new(0, 5)
    minCorner.Parent = MinimizeButton
    
    CloseButton.Size = UDim2.new(0, 30, 0, 25)
    CloseButton.Position = UDim2.new(1, -30, 0, 5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    CloseButton.Text = "Ã—"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 16
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Active = true
    CloseButton.Parent = TitleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 5)
    closeCorner.Parent = CloseButton
    
    -- Apply custom dragging (FIXED METHOD)
    makeDraggable(MainFrame, TitleBar)
    
    -- Content Frame
    ContentFrame.Size = UDim2.new(1, 0, 1, -35)
    ContentFrame.Position = UDim2.new(0, 0, 0, 35)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Active = false
    ContentFrame.Parent = MainFrame
    
    NoclipToggle.Size = UDim2.new(0.45, 0, 0, 35)
    NoclipToggle.Position = UDim2.new(0.025, 0, 0, 10)
    NoclipToggle.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    NoclipToggle.Text = "ðŸ”’ NOCLIP: OFF"
    NoclipToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    NoclipToggle.TextSize = 12
    NoclipToggle.Font = Enum.Font.Gotham
    NoclipToggle.Parent = ContentFrame
    
    local noclipCorner = Instance.new("UICorner")
    noclipCorner.CornerRadius = UDim.new(0, 8)
    noclipCorner.Parent = NoclipToggle
    
    AutoToggle.Size = UDim2.new(0.45, 0, 0, 35)
    AutoToggle.Position = UDim2.new(0.525, 0, 0, 10)
    AutoToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    AutoToggle.Text = "ðŸ¤– AUTO: OFF"
    AutoToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    AutoToggle.TextSize = 12
    AutoToggle.Font = Enum.Font.Gotham
    AutoToggle.Parent = ContentFrame
    
    local autoCorner = Instance.new("UICorner")
    autoCorner.CornerRadius = UDim.new(0, 8)
    autoCorner.Parent = AutoToggle
    
    StatusLabel.Size = UDim2.new(1, 0, 0, 25)
    StatusLabel.Position = UDim2.new(0, 0, 0, 50)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "Status: ðŸ”’ Disabled - No Barriers"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.TextSize = 11
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Center
    StatusLabel.Parent = ContentFrame
    
    SpeedLabel.Size = UDim2.new(0.6, 0, 0, 20)
    SpeedLabel.Position = UDim2.new(0, 10, 0, 80)
    SpeedLabel.BackgroundTransparency = 1
    SpeedLabel.Text = "Speed: " .. NOCLIP_SPEED
    SpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    SpeedLabel.TextSize = 11
    SpeedLabel.Font = Enum.Font.Gotham
    SpeedLabel.Parent = ContentFrame
    
    SpeedSlider.Size = UDim2.new(0.35, 0, 0, 20)
    SpeedSlider.Position = UDim2.new(0.6, 0, 0, 80)
    SpeedSlider.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    SpeedSlider.Text = tostring(NOCLIP_SPEED)
    SpeedSlider.TextColor3 = Color3.fromRGB(255, 255, 255)
    SpeedSlider.TextSize = 11
    SpeedSlider.Font = Enum.Font.Gotham
    SpeedSlider.TextXAlignment = Enum.TextXAlignment.Center
    SpeedSlider.Parent = ContentFrame
    
    local speedCorner = Instance.new("UICorner")
    speedCorner.CornerRadius = UDim.new(0, 4)
    speedCorner.Parent = SpeedSlider
    
    BypassToggle.Size = UDim2.new(0.45, 0, 0, 30)
    BypassToggle.Position = UDim2.new(0.025, 0, 0, 105)
    BypassToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    BypassToggle.Text = "ðŸš« BYPASS: ON"
    BypassToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    BypassToggle.TextSize = 11
    BypassToggle.Font = Enum.Font.Gotham
    BypassToggle.Parent = ContentFrame
    
    local bypassCorner = Instance.new("UICorner")
    bypassCorner.CornerRadius = UDim.new(0, 6)
    bypassCorner.Parent = BypassToggle
    
    DetectionToggle.Size = UDim2.new(0.45, 0, 0, 30)
    DetectionToggle.Position = UDim2.new(0.525, 0, 0, 105)
    DetectionToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    DetectionToggle.Text = "ðŸ” DETECT: ON"
    DetectionToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    DetectionToggle.TextSize = 11
    DetectionToggle.Font = Enum.Font.Gotham
    DetectionToggle.Parent = ContentFrame
    
    local detectCorner = Instance.new("UICorner")
    detectCorner.CornerRadius = UDim.new(0, 6)
    detectCorner.Parent = DetectionToggle
    
    -- Invisibility Toggle
    InvisibilityToggle.Size = UDim2.new(0.8, 0, 0, 30)
    InvisibilityToggle.Position = UDim2.new(0.1, 0, 0, 140)
    InvisibilityToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    InvisibilityToggle.Text = "ðŸ‘» INVISIBILITY: OFF"
    InvisibilityToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    InvisibilityToggle.TextSize = 11
    InvisibilityToggle.Font = Enum.Font.Gotham
    InvisibilityToggle.Parent = ContentFrame
    
    local invisCorner = Instance.new("UICorner")
    invisCorner.CornerRadius = UDim.new(0, 6)
    invisCorner.Parent = InvisibilityToggle
    
    EmergencyButton.Size = UDim2.new(0.8, 0, 0, 35)
    EmergencyButton.Position = UDim2.new(0.1, 0, 0, 175)
    EmergencyButton.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    EmergencyButton.Text = "ðŸš¨ EMERGENCY NOCLIP"
    EmergencyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    EmergencyButton.TextSize = 13
    EmergencyButton.Font = Enum.Font.GothamBold
    EmergencyButton.Parent = ContentFrame
    
    local emergencyCorner = Instance.new("UICorner")
    emergencyCorner.CornerRadius = UDim.new(0, 8)
    emergencyCorner.Parent = EmergencyButton
    
    -- Event Handlers
    NoclipToggle.MouseButton1Click:Connect(function()
        if NOCLIP_ENABLED then
            disableNoclip()
        else
            enableNoclip()
        end
    end)
    
    AutoToggle.MouseButton1Click:Connect(function()
        AUTO_NOCLIP = not AUTO_NOCLIP
        if AUTO_NOCLIP then
            AutoToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
            AutoToggle.Text = "ðŸ¤– AUTO: ON"
        else
            AutoToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            AutoToggle.Text = "ðŸ¤– AUTO: OFF"
        end
    end)
    
    BypassToggle.MouseButton1Click:Connect(function()
        BYPASS_RELOAD = not BYPASS_RELOAD
        if BYPASS_RELOAD then
            BypassToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
            BypassToggle.Text = "ðŸš« BYPASS: ON"
        else
            BypassToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            BypassToggle.Text = "ðŸš« BYPASS: OFF"
        end
    end)
    
    DetectionToggle.MouseButton1Click:Connect(function()
        SMART_DETECTION = not SMART_DETECTION
        if SMART_DETECTION then
            DetectionToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
            DetectionToggle.Text = "ðŸ” DETECT: ON"
        else
            DetectionToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            DetectionToggle.Text = "ðŸ” DETECT: OFF"
        end
    end)
    
    InvisibilityToggle.MouseButton1Click:Connect(function()
        toggleInvisibility()
        if INVISIBILITY_ENABLED then
            InvisibilityToggle.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
            InvisibilityToggle.Text = "ðŸ‘» INVISIBILITY: ON"
        else
            InvisibilityToggle.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            InvisibilityToggle.Text = "ðŸ‘» INVISIBILITY: OFF"
        end
    end)
    
    EmergencyButton.MouseButton1Click:Connect(function()
        enableNoclip()
        -- Force noclip selama 3 detik
        spawn(function()
            wait(3)
            if AUTO_NOCLIP then
                disableNoclip()
            end
        end)
    end)
    
    -- Minimize/Close functionality dengan smooth animations
    MinimizeButton.MouseButton1Click:Connect(function()
        guiMinimized = not guiMinimized
        
        local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
        
        if guiMinimized then
            -- Minimize animation
            ContentFrame.Visible = false
            local minimizeTween = TweenService:Create(MainFrame, tweenInfo, {
                Size = UDim2.new(0, 300, 0, 35)
            })
            minimizeTween:Play()
            MinimizeButton.Text = "+"
            MinimizeButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            -- Maximize animation
            local maximizeTween = TweenService:Create(MainFrame, tweenInfo, {
                Size = UDim2.new(0, 300, 0, 290)
            })
            maximizeTween:Play()
            
            maximizeTween.Completed:Connect(function()
                ContentFrame.Visible = true
            end)
            
            MinimizeButton.Text = "âˆ’"
            MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        end
    end)
    
    CloseButton.MouseButton1Click:Connect(function()
        local tweenInfo = TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In)
        
        -- Close animation - shrink to center
        local closeTween = TweenService:Create(MainFrame, tweenInfo, {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 1
        })
        
        -- Fade out all elements
        local fadeElements = {TitleLabel, MinimizeButton, CloseButton}
        for _, element in pairs(fadeElements) do
            TweenService:Create(element, tweenInfo, {
                TextTransparency = 1,
                BackgroundTransparency = 1
            }):Play()
        end
        
        closeTween:Play()
        closeTween.Completed:Connect(function()
            guiVisible = false
            ScreenGui:Destroy()
            print("ðŸ”® Warpah Noclip GUI closed - Use keybinds to control (G to reopen)")
        end)
    end)
    
    SpeedSlider.FocusLost:Connect(function()
        local newSpeed = tonumber(SpeedSlider.Text)
        if newSpeed and newSpeed > 0 and newSpeed <= 100 then
            NOCLIP_SPEED = newSpeed
            SpeedLabel.Text = "Speed: " .. NOCLIP_SPEED
            
            -- Update humanoid speed
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                LocalPlayer.Character.Humanoid.WalkSpeed = NOCLIP_SPEED
            end
        else
            SpeedSlider.Text = tostring(NOCLIP_SPEED)
        end
    end)
    
    -- Real-time status updates
    spawn(function()
        while ScreenGui.Parent and guiVisible do
            wait(0.2)
            
            -- Update toggle colors dan text
            if NOCLIP_ENABLED then
                NoclipToggle.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
                NoclipToggle.Text = "ðŸ”“ NOCLIP: ON"
            else
                NoclipToggle.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
                NoclipToggle.Text = "ðŸ”’ NOCLIP: OFF"
            end
            
            -- Update status
            local barrierDetected = detectBarrier()
            local stuckDetected = detectStuck()
            
            if NOCLIP_ENABLED then
                StatusLabel.Text = "Status: ðŸ”“ ACTIVE - Phasing through walls"
                StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            elseif barrierDetected or stuckDetected then
                StatusLabel.Text = "Status: âš ï¸ BARRIER/STUCK DETECTED"
                StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 0)
            else
                StatusLabel.Text = "Status: âœ… CLEAR - No obstacles"
                StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            end
        end
    end)
end

-- Keybind untuk toggle cepat
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    -- N key untuk toggle noclip
    if input.KeyCode == Enum.KeyCode.N then
        if NOCLIP_ENABLED then
            disableNoclip()
        else
            enableNoclip()
        end
    end
    
    -- B key untuk emergency noclip
    if input.KeyCode == Enum.KeyCode.B then
        enableNoclip()
        print("ðŸš¨ Emergency noclip activated!")
    end
    
    -- I key untuk toggle invisibility
    if input.KeyCode == Enum.KeyCode.I then
        toggleInvisibility()
    end
    
    -- G key untuk toggle GUI visibility dengan smooth animation
    if input.KeyCode == Enum.KeyCode.G then
        if not guiVisible then
            createNoclipGUI()
            guiVisible = true
            
            -- Smooth entrance animation
            local gui = LocalPlayer.PlayerGui:FindFirstChild("WarpahNoclipGUI")
            if gui and gui:FindFirstChild("Frame") then
                local frame = gui.Frame
                frame.Size = UDim2.new(0, 0, 0, 0)
                frame.Position = UDim2.new(0.5, 0, 0.5, 0)
                frame.BackgroundTransparency = 1
                
                local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
                local entranceTween = TweenService:Create(frame, tweenInfo, {
                    Size = UDim2.new(0, 300, 0, 290),
                    Position = UDim2.new(0.5, -150, 0.5, -145),
                    BackgroundTransparency = 0.05
                })
                entranceTween:Play()
            end
        end
    end
end)

-- Auto-check loop
RunService.Heartbeat:Connect(function()
    autoNoclipCheck()
end)

-- Character respawn handler
LocalPlayer.CharacterAdded:Connect(function(character)
    wait(1)
    originalStates = {}
    lastPosition = nil
    stuckTimer = 0
    INVISIBILITY_ENABLED = false
    
    if NOCLIP_ENABLED then
        enableNoclip()
    end
end)

-- Initialize
print("ðŸ”® Warpah No Clip System Loaded!")
print("ðŸ“ Controls:")
print("   - N key: Toggle Noclip")
print("   - B key: Emergency Noclip")
print("   - I key: Toggle Invisibility")
print("   - G key: Show GUI (if closed)")
print("   - GUI: Full control panel with minimize/close")

createNoclipGUI()

-- Notification
local function showNotification(title, text)
    pcall(function()
        game.StarterGui:SetCore("SendNotification", {
            Title = title;
            Text = text;
            Duration = 5;
        })
    end)
end

showNotification("ðŸ”® Warpah No Clip Ready", "N=toggle, B=emergency, I=invisible, G=GUI")
